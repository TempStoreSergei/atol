# Changelog

Все изменения в проекте документируются в этом файле.

## [0.3.0] - 2024-10-14

### Добавлено

#### REST API сервер (FastAPI)
- **Модульная архитектура** с разделением endpoint'ов по категориям:
  - `connection_routes` - Управление подключением (3 endpoint'а)
  - `receipt_routes` - Операции с чеками (7 endpoint'ов)
  - `shift_routes` - Операции со сменами (8 endpoint'ов)
  - `cash_routes` - Кассовые операции (5 endpoint'ов)
  - `query_routes` - Запросы информации от ККТ (18 endpoint'ов)
  - `print_routes` - Нефискальная печать (10 endpoint'ов)

#### Расширенная обработка ошибок
- **AtolDriverError** с тремя уровнями информации:
  - `error_code` - числовой код ошибки (0-603)
  - `error_description` - детальное описание на русском
  - `message` - контекст операции
- Автоматическое получение кодов ошибок через `fptr.errorCode()` и `fptr.errorDescription()`
- Глобальный обработчик ошибок для FastAPI с форматированным JSON-ответом
- Ссылки на документацию АТОЛ для каждого кода ошибки
- Метод `to_dict()` для структурированных API-ответов
- Форматированный вывод: `[Код 15] Описание`

#### Полный словарь ошибок (errors.py)
- **269 кодов ошибок** (000-603) с русскими описаниями
- Организованы по группам:
  - Успех (0)
  - Ошибки подключения (1-15)
  - Ошибки операций (16-50)
  - Ошибки изображений и оплаты (51-100)
  - Ошибки смены и отчетов (101-250)
  - Ошибки ФН и тарификации (251-400)
  - Ошибки маркировки (401-500)
  - Ошибки скриптов (501-600)
  - Ошибки удалённого подключения (601-603)

#### Новые endpoint'ы для диагностики
- `GET /driver/error` - получить последнюю ошибку драйвера
- `POST /driver/error/reset` - сбросить информацию об ошибке
- `GET /driver/errors/codes` - полный справочник 269 кодов ошибок
- `GET /driver/version` - версия драйвера
- `POST /driver/label` - изменить метку драйвера для логирования

#### Управление подключением
- `POST /connection/open` - открыть соединение (TCP/USB/Serial/Bluetooth)
- `POST /connection/close` - закрыть соединение
- `GET /connection/status` - статус подключения

#### Операции с чеками
- `POST /receipt/open` - открыть чек
- `POST /receipt/add-item` - добавить товар
- `POST /receipt/add-payment` - добавить оплату
- `POST /receipt/close` - закрыть чек с фискальными данными
- `POST /receipt/cancel` - отменить чек
- `POST /receipt/print-text` - напечатать текст в чеке
- `POST /receipt/print-barcode` - напечатать штрихкод в чеке

#### Операции со сменами
- `POST /shift/open` - открыть смену
- `POST /shift/close` - закрыть смену (Z-отчет)
- `GET /shift/status` - статус смены
- `POST /shift/x-report` - X-отчет без гашения
- `POST /shift/report-by-departments` - отчет по отделам
- `POST /shift/report-by-taxes` - отчет по налогам
- `POST /shift/report-by-cashiers` - отчет по кассирам
- `POST /shift/report-by-hours` - отчет по часам

#### Кассовые операции
- `POST /cash/in` - внесение наличных
- `POST /cash/out` - изъятие наличных
- `GET /cash/sum` - сумма в денежном ящике
- `POST /cash/drawer/open` - открыть денежный ящик
- `GET /cash/drawer/status` - статус ящика

#### Запросы информации (QueryDataService)
- `GET /query/status` - общая информация и статус ККТ
- `GET /query/short-status` - краткий статус
- `GET /query/shift-totals` - итоги смены
- `GET /query/fn-status` - статус фискального накопителя
- `GET /query/fn-info` - информация о ФН
- `GET /query/shift-numbers` - номера смен в ФН
- `GET /query/receipt-by-number` - данные чека по номеру
- `GET /query/marking-status` - статус маркировки товара
- `GET /query/ofd-exchange-status` - статус обмена с ОФД
- `GET /query/operators` - список операторов
- `GET /query/correction-reasons` - причины коррекции
- `GET /query/payment-types` - типы оплаты
- `GET /query/tax-rates` - ставки налогов
- `GET /query/goods-sections` - товарные секции
- `GET /query/taxes` - налоги по секциям
- `GET /query/receipt-state` - состояние открытого чека
- `GET /query/unit-types` - единицы измерения
- `GET /query/agent-types` - признаки агента

#### Нефискальная печать
- `POST /print/document/begin` - начать нефискальный документ
- `POST /print/document/end` - закончить нефискальный документ
- `POST /print/cliche` - напечатать клише
- `POST /print/text` - напечатать текст с форматированием
- `POST /print/feed` - промотать ленту (пустые строки)
- `POST /print/barcode` - напечатать штрихкод (1D/2D)
  - Поддержка всех типов: EAN13, EAN8, Code39, Code128, QR, PDF417, AZTEC, DataMatrix
- `POST /print/picture` - напечатать картинку из файла
- `POST /print/picture-by-number` - напечатать картинку из памяти
- `POST /print/text-with-barcode` - текст рядом с QR-кодом
- `POST /print/example-nonfiscal` - пример нефискального документа

#### Форматированный текст
- Управляющие символы для форматирования:
  - `\n` - перевод строки
  - `\sXNN` - вставить символ X NN раз
  - `\fNN` - выбрать шрифт NN
  - `\aX` - выравнивание (l=влево, c=центр, r=вправо)

#### Сервисный слой
- **QueryDataService** - единый сервис для запросов queryData
- Метод `_execute_query()` для устранения дублирования кода
- Размещен в `services/query_data.py`

#### Структура проекта
- Создана папка `routes/` для всех FastAPI роутеров
- Создана папка `services/` для бизнес-логики
- Разделение ответственности: `api/` только для клиентов и драйверов
- Файл `routes/__init__.py` для чистого экспорта

#### Автоматическое подключение
- Поддержка автоподключения при старте сервера
- Настройка через переменные окружения:
  - `ATOL_CONNECTION_TYPE` (tcp/usb/serial/bluetooth)
  - `ATOL_HOST` и `ATOL_PORT` для TCP
  - `ATOL_SERIAL_PORT` и `ATOL_BAUDRATE` для Serial

#### Документация
- Обновлен `docs/REST_API.md` с расширенным разделом по обработке ошибок
- Примеры обработки ошибок на Python, JavaScript, cURL
- Таблица наиболее частых ошибок с решениями
- Создан `GEMINI.md` с полным описанием улучшенной обработки ошибок

### Изменено

- **Архитектура проекта** полностью реорганизована:
  - Все роутеры перенесены из `api/` в `routes/`
  - QueryDataService перенесен из `api/` в `services/`
  - Обновлены все относительные импорты
- **server.py** сокращен с 1034 до 335 строк (68% сокращение)
- **Обработка ошибок** полностью переработана с добавлением диагностической информации
- Версия API обновлена с 0.2.0 до 0.3.0

### Исправлено

- Исправлены импорты: использование относительных импортов вместо абсолютных
- Ошибка `ModuleNotFoundError: No module named 'libfptr10'` при использовании абсолютных импортов
- Дублирование кода в 19 endpoint'ах queryData - теперь используется единый сервис
- Улучшена диагностика ошибок драйвера с кодами и описаниями

### Технические детали

#### Производительность
- Параллельное выполнение независимых запросов через множественные tool calls
- Оптимизированные relative imports для быстрой загрузки модулей
- Единый QueryDataService устраняет дублирование кода

#### Совместимость
- Обратная совместимость с существующим кодом
- Опциональные параметры в AtolDriverError
- Все существующие endpoint'ы работают без изменений

#### Тестирование
- Протестирована расширенная обработка ошибок
- Проверены все форматы ошибок и JSON-ответов
- Подтверждена работа всех endpoint'ов

## [0.2.0] - 2024-01-15

### Добавлено

#### Основной функционал
- **AtolDriver** - полноценный Python wrapper для драйвера АТОЛ ККТ v.10 (libfptr10)
- Поддержка всех типов подключения: TCP/IP, USB, Serial (COM-порт), Bluetooth
- Контекстный менеджер для автоматического управления подключением

#### Операции с чеками
- Открытие чеков всех типов: продажа, возврат, покупка
- Добавление товаров с полными атрибутами (цена, количество, НДС, единица измерения)
- Поддержка всех типов оплаты: наличные, электронные, предоплата, кредит
- Смешанная оплата (несколько платежей в одном чеке)
- Закрытие чека с получением фискальных данных
- Отмена чека

#### Чеки коррекции
- Открытие чеков коррекции (самостоятельные и по предписанию)
- Добавление позиций коррекции с описанием
- Документ основания для коррекции

#### Управление сменой
- Открытие смены с указанием кассира
- Закрытие смены (Z-отчет)
- Получение статуса смены (открыта/закрыта, номер, количество чеков)
- Печать X-отчета без гашения

#### Денежные операции
- Внесение наличных в кассу
- Выплата наличных из кассы

#### Информация об устройстве
- Получение полной информации о ККТ (модель, серийный номер, версия ПО)
- Получение данных о фискальном накопителе
- ИНН и регистрационный номер ККТ

#### Модели данных
- Обновлены все Enum на IntEnum для совместимости с драйвером
- Добавлен `PaymentMethodType` (признак способа расчета по 54-ФЗ)
- Добавлен `PaymentObjectType` (признак предмета расчета по 54-ФЗ)
- Расширен класс `Item` дополнительными атрибутами
- Добавлены типы коррекции в `ReceiptType`

#### Вспомогательные функции
- Звуковой сигнал (beep)
- Открытие денежного ящика
- Отрезка чека
- Проверка подключения

#### Документация
- Полное обновление README.md с примерами
- Создан API_REFERENCE.md с подробным описанием всех методов
- Создан INSTALLATION.md с инструкциями по установке
- Обновлен CLAUDE.md с архитектурой и рекомендациями
- Добавлен CHANGELOG.md

#### Примеры
- `driver_basic_usage.py` - базовый пример продажи
- `driver_advanced_usage.py` - расширенные примеры:
  - Чек возврата
  - Смешанная оплата
  - Чек коррекции
  - Денежные операции
  - Управление сменой
  - Разные типы подключения
  - Контекстный менеджер

#### Инструменты разработки
- Обновлен Makefile с новыми командами
- Добавлена команда `make help`
- Добавлена команда `make run-advanced`
- Улучшены команды lint и format

### Изменено

- Версия обновлена с 0.1.0 (Alpha) до 0.2.0 (Beta)
- `VatType` переименован в `TaxType` и изменен на IntEnum
- `ReceiptType` изменен на IntEnum со значениями 0-5
- `PaymentType` изменен на IntEnum со значениями 0-4
- Обновлен `setup.py` с дополнительными метаданными
- Обновлен `requirements.txt` с комментариями о драйвере
- Обновлен `__init__.py` для удобного импорта всех классов

### Исправлено

- Исправлена кодировка в некоторых файлах
- Улучшена обработка ошибок драйвера
- Добавлено логирование во все операции

## [0.1.0] - 2024-01-01

### Добавлено

- Первоначальная структура проекта
- Stub-реализации для AtolClient и AtolWebServer
- Базовые модели данных (Receipt, Item, Payment, DeviceInfo)
- Конфигурация через Pydantic и .env
- Начальная документация
- Структура тестов

### Известные ограничения

- AtolClient и AtolWebServer содержат только заглушки
- FiscalService не реализован
- Нет unit и integration тестов
- DeviceInfo.from_dict() не реализован

---

## Формат

Этот файл следует формату [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

### Типы изменений

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - в случае уязвимостей
